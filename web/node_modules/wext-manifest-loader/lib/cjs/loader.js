"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.loader = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const schema_utils_1 = __importDefault(require("schema-utils"));
const loader_utils_1 = require("loader-utils");
const constants_1 = require("./constants");
const transform_1 = require("./transform");
const packageJSONPath = path_1.default.resolve('./package.json');
const schema = {
    type: 'object',
    properties: {
        usePackageJSONVersion: {
            type: 'boolean',
        },
    },
};
function loader(source) {
    if (this.cacheable) {
        this.cacheable();
    }
    this.addDependency(packageJSONPath);
    const options = (0, loader_utils_1.getOptions)(this);
    (0, schema_utils_1.default)(schema, options, {
        name: 'Wext Manifest Loader',
    });
    const usePackageJSONVersion = (options.usePackageJSONVersion && true) || false;
    let content = {};
    if (typeof source === 'string') {
        try {
            content = JSON.parse(source);
        }
        catch (err) {
            this.emitError(err);
        }
    }
    const vendor = process.env.TARGET_BROWSER;
    if (vendor) {
        if (!constants_1.browserVendors.includes(vendor)) {
            return this.emitError(`${constants_1.LOADER_NAME}: browser ${vendor} is not supported`);
        }
    }
    else {
        return this.emitError(`${constants_1.LOADER_NAME}: TARGET_BROWSER variable missing`);
    }
    const manifest = (0, transform_1.transformManifest)(content, vendor);
    if (usePackageJSONVersion) {
        try {
            const packageJSON = JSON.parse(fs_1.default.readFileSync(packageJSONPath, 'utf-8'));
            manifest.version = packageJSON.version.replace('-beta.', '.');
        }
        catch (err) {
            this.emitError(err);
        }
    }
    const outputPath = (0, loader_utils_1.interpolateName)(this, 'manifest.json', {
        source,
    });
    const publicPath = `__webpack_public_path__ + ${JSON.stringify(outputPath)}`;
    const formattedJson = JSON.stringify(manifest, null, 2)
        .replace(/\u2028/g, '\\u2028')
        .replace(/\u2029/g, '\\u2029');
    this.emitFile(outputPath, formattedJson);
    return `module.exports = ${publicPath};`;
}
exports.loader = loader;
